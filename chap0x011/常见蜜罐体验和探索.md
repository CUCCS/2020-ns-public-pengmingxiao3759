# chap0x11实验报告
## 常见蜜罐体验和探索

### 一、实验目的
* 了解蜜罐的分类和基本原理
* 了解不同类型蜜罐的适用场合
* 掌握常见蜜罐的搭建和使用

### 二、实验要求
* 记录蜜罐的详细搭建过程；
* 使用 nmap 扫描搭建好的蜜罐并分析扫描结果，同时分析「 nmap 扫描期间」蜜罐上记录得到的信息；
* 如何辨别当前目标是一个「蜜罐」？以自己搭建的蜜罐为例进行说明；

### 三、实验环境
* 从 paralax/awesome-honeypots 中选择 1 种低交互蜜罐和 1 种中等交互蜜罐进行搭建实验 
    * 推荐 SSH 蜜罐
* 靶机：kali-victim-1(10.0.2.15)  
* 攻击者主机：kali-attacker(10.0.2.8)
    * 在victim中搭建蜜罐，attacker去攻击伪victim
* 网络配置   
![pic1](pic/网络配置.png)  
* 网络测试  
![pic2](pic/网络连通性.png)  
![pic3](pic/网络连通性1.png)  
* 实验拓扑结构  
![pic4](pic/拓扑结构.png)  

### 四、实验过程
#### 1.蜜罐搭建  
* 将ssh_honeypot文件git clone到victim1本地  
    * ```git clone https://github.com/droberson/ssh-honeypot.git```
![pic1-1](pic/clone仓库.png)  
* 默认22端口给蜜罐使用，编辑配置文件将ssh的端口号改为一个不常用的端口号56，让出22端口位置  
   *  ```vi /etc/ssh/sshd_config```
![pic1-2](pic/更改ssh端口.png)  
* 重启ssh服务，安装docker服务并启动  
    * ```service ssh restart```  
    * ```apt-get install docker docker-compose```
    * ```service docker start```
![pic1-3](pic/安装docker1.png)  
* 安装ssh-honeypot，首先确保libssh&libjson-c已经安装
    * ```apt install libssh-dev libjson-c-dev```  
    * ```make```  
    * ```ssh-keygen -t rsa -f ./ssh-honeypot.rsa```  
    * ```bin/ssh-honeypot -r ./ssh-honeypot.rsa```  
![pic1-4](pic/安装honeypot1.png)   
    * 注意：
        * 是在ssh-honeypot目录下进行操作
        * 一定要输入make命令。make命令的作用是进行编译
* 将cowrie文件git clone到victim1本地  
![pic1-5](pic/cloneCowrie.png)   
* 安装镜像
    * ```docker pull cowrie/cowrie```   
![pic1-6](pic/安装cowrie.png) 
* 启动cowrie，在端口2222开启  
    * ```docker run -p 2222:2222 cowrie/cowrie```   
![pic1-7](pic/启动cowrie.png)  

#### 2.蜜罐测试  
* 扫描ssh-Honeypot蜜罐
    * 攻击者主机尝试连接靶机(靶机的ip更改为10.0.2.10)，发现无论如何都无法连接靶机  
    ![pic2-1](pic/ssh无法连接.png)  
    * 不论attacker输入的密码正确与否，victim1都会拒绝ssh连接
    * 日志能记录攻击者行为  
    * 攻击者使用TCP stealth scan、XMAS scan、FIN scan、NULL scan
    * TCP stealth scan：收到syn-ack，端口为打开状态  
    ![pic2-2](pic/ssh-stealth.png)  
    * XMAS scan：22端口、111端口为打开或过滤状态  
    ![pic2-3](pic/ssh-XMAS.png)  
    * FIN scan：22端口、111端口为打开或过滤状态  
    ![pic2-4](pic/ssh-FIN.png)  
    * Null scan：22端口、111端口为打开或过滤状态  
    ![pic2-5](pic/ssh-Null.png)  
    * 查看日志，并未发现有攻击者主机扫描端口操作的记录  

* 扫描cowrie蜜罐
    * 攻击者attacker主机尝试和victim1进行ssh连接
    * 在victim将蜜罐运行在2222端口,attacker请求和victim1进行ssh连接  
    ```ssh root@10.0.2.10 -p 2222```  
    * 观察到攻击者的ip地址等信息也显示在victim的界面上,当输入密码成功后连接成功
    * 查看日志文件  
    ```docker exec -it trusting_franklin tail -F /cowrie/cowrie-git/var/log/cowrie/cowrie.json```
    * Tcp connect：端口为开启状态  
        记录了Attacker的ip、端口号、session等信息  
    ![pic2-7](pic/cowrie-TCP.png)  
    TCP stealth scan ：收到syn-ack，说明端口为打开状态  
    ![pic2-8](pic/cowrie-stealth.png)  
    * XMAS scan ：Attacker的扫描没有被记录，22端口、111端口为打开或过滤状态  
    ![pic2-9](pic/cowrie-XMAS.png)  
    * FIN scan ：Attacker的扫描没有被记录，22端口、111端口为打开或过滤状态  
    ![pic2-10](pic/cowrie-FIN.png)  
    * Null scan ：Attacker的扫描没有被记录，22端口、111端口为打开或过滤状态  
    ![pic2-10](pic/cowrie-Null.png)  

#### 3.问题
* (1)如何辨别当前目标是一个「蜜罐」？以自己搭建的蜜罐为例进行说明
    * 进行ssh连接尝试，若无论密码正确与否都不能连接，则很可能暴露其是低交互蜜罐；若可以连接ssh，观察一些指令的报错信息，可以判断出蜜罐的存在。  
    ![pic3-1](pic/辨别蜜罐.png)  

* (2)总结常见的蜜罐识别和检测方法
    * 低交互蜜罐：模拟服务和漏洞以便收集信息和恶意软件，但是攻击者无法和该系统进行交互，因此不能给攻击者提供完整的操作系统环境，可以通过使用一些复杂的命令和操作检测是不是处在蜜罐环境中。常用方法是产生一个网络请求。如```curl xxxxxx```然后检测服务器请求,如果没有说明已经进入了一个蜜罐.
    * 高交互蜜罐：攻击者可以几乎自由的访问系统资源直至系统重新清除恢复,主要采用虚拟主机进行部署。可以通过读取路由表,arp记录,系统日志等来分析它的网络交互。一个蜜罐通常是与其他计算机没有关联或被屏蔽的,所以如果读取到异常数据,基本可以认定是蜜罐。

### 五、实验总结  
* ssh-honeypot是一个低交互式的蜜罐，仅用于简单记录ssh连接请求数据的简易蜜罐，TCP stealth scan、XMAS scan、FIN scan、NULL scan等攻击不会被捕获。
* cowrie是一个相对交互式较高、较完善的蜜罐，可以进行ssh远程连接等操作。TCP connect会被记录，stealth scan、XMAS scan、FIN scan、NULL scan等攻击不会被记录，这个蜜罐提供的命令、错误提示等比较全面，但部分命令的错误输出会暴露这是个 python 蜜罐。


- - - 
* *参考资料*  
    [Awesome Honeypots](https://github.com/paralax/awesome-honeypots)   
    [SSH Honeypot](https://github.com/droberson/ssh-honeypot)  
    [Cowrie](https://github.com/cowrie/cowrie)  
    [蜜罐检测技术](https://bbs.ichunqiu.com/thread-32505-1-1.html)
